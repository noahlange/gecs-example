class ${}let M="ModuleSymbhasOwnPr-0123456789ABCDEFGHNRVfgctiUvz_KqYTJkLxpZXIjQW",R=(n=21)=>{let t="",e=n;for(;e--;)t+=M[Math.random()*64|0];return t},q=()=>R();function O(){return q()}function*V(){let n=1n;do yield 1n<<n++;while(!0)}const C=()=>{const n=V();return()=>n.next().value};class T{constructor(t,e){this.items={},this.items=t.reduce((s,i)=>({...s,[i]:!0}),{}),this.onChange=e}*[Symbol.iterator](){yield*this.all()}all(){return Object.keys(this.items)}has(...t){for(const e of t)if(!(e in this.items))return!1;return!0}add(...t){let e=!1;for(const s of t)s in this.items||(this.items[s]=!0,e=!0);return e&&this.onChange?.(),this}clear(){this.items={},this.onChange?.()}delete(...t){let e=!1;for(const s of t)s in this.items&&(delete this.items[s],e=!0);return e&&this.onChange?.(),!0}remove(...t){this.delete(...t)}}const v="_a",A="$id$";var l;(function(n){n[n.SOME=0]="SOME",n[n.ALL=1]="ALL",n[n.ANY=2]="ANY",n[n.NONE=3]="NONE"})(l||(l={}));var I;(function(n){n[n.NONE=0]="NONE",n[n.PENDING=1]="PENDING",n[n.RESOLVED=2]="RESOLVED",n[n.FAILED=3]="FAILED"})(I||(I={}));class F{constructor(t){this.stack=[],this.refs={},this.entities={},this.ctx=t}set(t,e,s){let i=t;for(;e.length;){const r=e.shift();r&&(e.length?i=i[r]:i[r]=s)}}recreateEntityReferences(){for(const[t,e]of Object.entries(this.refs)){const s=this.entities[t];for(const[i,r]of e)this.set(s,i,this.entities[r])}}deserializeValue(t,e,s){const{refs:i,stack:r}=this;let o=s;switch(r.push(s),typeof s){case"object":{if(Array.isArray(s))o=s.map((c,a)=>{const h=t.concat([a+""]);return this.deserializeValue(h,e,c)});else if(s)for(const c of Object.getOwnPropertyNames(s)){const[a,h]=[s[c],t.concat([c])];r.includes(a)||(o=a&&this.deserializeValue(h,e,a))}break}case"string":{if(s.startsWith(A)){const c=s.replace(`${A}|`,""),a=i[e]??[];a.push([t,c]),i[e]=a}/^[0-9]+n$/.test(s)&&(o=BigInt(s.slice(0,-1)));break}}return r.pop(),o}deserializeEntities(t){const{components:e,entities:s}=this.ctx.registrations,i={},r=[];for(const{id:o,tags:c,type:a,$:h}of t.entities){if(!(a in s)){const m=a.split("|");if(m.some(p=>!e[p])){const p=m.filter(d=>!e[d]);/\|/.test(a)?console.warn(`Missing components: ${p.join(", ")}`):console.warn(`Missing entities/components: ${p.join(", ")}`);continue}s[a]=i[a]=D.with(...a.split("|").map(p=>e[p]))}const y=Object.getOwnPropertyNames(h).map(m=>this.deserializeValue(["$",m],o,h[m]));r.push({id:o,entity:s[a],data:y,tags:c})}this.ctx.register(i);for(const{id:o,entity:c,data:a,tags:h}of r){const y=this.entities[o]=this.ctx.create(c,a,h);y.id=o}this.stack=[],this.recreateEntityReferences(),this.stack=[]}deserialize(t){this.ctx.state=t.state,this.deserializeEntities(t)}}class G{constructor(){this.map=new Map}all(){const t=[];for(const e of this.map.values())t.push(...e);return Array.from(new Set(t))}keys(){return Array.from(this.map.keys())}get(t){const e=[];for(const s of t)e.push(...this.map.get(s)??[]);return e}append(t,e){const s=this.map.get(t)??new Set;this.map.set(t,s.add(e))}remove(t,e){const s=this.map.get(t);s&&s.delete(e)}}function Y(n){return!("type"in n)}const L=new Map;function B(n,...t){const e=L.get(n)??[],s=class extends n{},i=[...e,...t];return L.set(s,i),Object.defineProperty(s.prototype,"items",{value:i.slice(),writable:!0}),s}function K(n,...t){return class extends n{get items(){return t}}}function S(...n){let t=0n;for(const e of n)t|=e;return t}const N={any(n,t){return!n||(n&t)>0n},all(n,t){return(n&t)===n},none(n,t){return!t||!(t&n)}};function H(n){return!!(n.prototype?.tick??n.prototype?.stop??n.prototype?.start)}const J={[l.NONE]:N.none,[l.ALL]:N.all,[l.ANY]:N.any};var x;(function(n){n[n.PENDING=0]="PENDING",n[n.RESOLVED=1]="RESOLVED",n[n.FAILED=2]="FAILED"})(x||(x={}));class W{constructor(t,e){this.id=O(),this.key=0n,this.destroyed=!1,this.unresolved=new Set,this.results=new Set,this.tags=new Set,this.keys=new Map,this.attempts=0,this.status=x.PENDING,this.reducer=(s,i)=>{if(i.constraint===l.SOME)return s;const r=i.ids.map(o=>{const c=this.manager.getID(o);return c===null?this.unresolved.add(o):this.unresolved.delete(o),c}).filter(o=>o!==null);return s[i.constraint]=s[i.constraint]?S(s[i.constraint],...r):S(...r),s},this.targets={[l.ANY]:null,[l.ALL]:null,[l.NONE]:null},this.manager=t,this.steps=e.filter(s=>s.constraint!==l.SOME)}init(){const t={[l.ALL]:[],[l.ANY]:[],[l.NONE]:[]};for(const e of this.steps)e.constraint!==l.SOME&&(this.tags.add(e.constraint),t[e.constraint].push(e));for(const e of this.tags)this.targets=t[e].reduce(this.reducer,this.targets)}filter(t){let e=this.keys.get(t)??null;if(e===null){e=!0;for(const s of this.tags){const i=this.targets[s];if(!i||!J[s](i,t)){e=!1;break}}this.keys.set(t,e)}return e}refresh(){const t=this.manager.index.keys().filter(e=>this.filter(e));this.results=new Set(this.manager.index.get(t))}update(t,e){for(const s of e)this.results.delete(s);for(const s of t){const i=this.keys.get(s.key)??null;(i||i===null&&this.filter(s.key))&&this.results.add(s)}}destroy(){this.destroyed=!0}resolve(){if(this.attempts>=10){this.status=x.FAILED;const t=Array.from(this.unresolved).join('", "');console.warn(`Failed to resolve "${t}" after 10 attempts. Pre-register or manually invoke \`.refresh()\` to reload.`)}else if(this.attempts++,this.init(),this.unresolved.size===0){let t=0n;this.status=x.RESOLVED;for(const e of Object.values(this.targets))t|=e??0n;this.key=t,this.refresh()}}*[Symbol.iterator](){this.status===x.PENDING&&this.resolve(),yield*this.results}get(){return Array.from(this)}first(){for(const t of this)return t;return null}}class j{constructor(t){this.key="",this.resolved=null,this.criteria=[],this.handle={components:{all:this.component(l.ALL),any:this.component(l.ANY),some:this.component(l.SOME),none:this.component(l.NONE)},tags:{all:this.tag(l.ALL),any:this.tag(l.ANY),some:this.tag(l.SOME),none:this.tag(l.NONE)}},this.components=Object.assign(this.handle.components.all,this.handle.components),this.tags=Object.assign(this.handle.tags.all,this.handle.tags),this.manager=t,this.reset()}reset(){return this.state&&(this.key+=this.state.tag+"|"+this.state.ids.join(",")+"::",this.criteria.push({constraint:this.state.tag??l.ALL,ids:this.state.ids.slice()})),this.state={tag:null,ids:[]},this}tag(t){return(...e)=>{for(let s=0;s<e.length;s++){const i=this.manager.getTagKey(e[s]);i&&this.state.ids.push(i)}return this.state.tag=t,this.reset()}}component(t){return(...e)=>(this.state.ids.push(...e.map(s=>s.type)),this.state.tag=t,this.reset())}get query(){return this.resolved??=this.manager.getQuery(this.criteria,this.key)}get(){return this.query.get()}first(){return this.query.first()}[Symbol.iterator](){return this.query[Symbol.iterator]()}}class _{constructor(){this.id=C(),this.registry={}}add(...t){const e=[];for(const s of t)this.registry[s]||(this.registry[s]=this.id()),e.push(this.registry[s]);return S(...e)}getID(t){return this.registry[t]??null}}class U{constructor(){this.registry=new _,this.queries={},this.tags={},this.toDestroy=new Set,this.toIndex=new Map,this.index=new G}get $(){return new j(this)}getEntityKey(t){return this.registry.add(...t.items.map(e=>e.type),...Array.from(t.tags).map(e=>this.getTagKey(e)))}getQuery(t,e){return this.queries[e]||(this.queries[e]=new W(this,t)),this.queries[e]}register(...t){this.registry.add(...t.map(e=>e.type))}getTagKey(t){const e=this.tags[t]??=O();return this.registry.add(e),e}indexEntity(t){this.toIndex.set(t,t.key??null)}tick(){const t=[],e=Array.from(this.toDestroy);let s=0n;for(const[i,r]of this.toIndex)i.key=this.getEntityKey(i),s|=r|i.key,r?i.key!==r&&(e.push(i),this.toDestroy.has(i)||t.push(i)):(t.push(i),this.index.append(i.key,i));for(const[i,r]of Object.entries(this.queries)){if(r.destroyed){delete this.queries[i];continue}N.any(s,r.key)&&r.update(t,e)}for(const i of this.toDestroy)this.index.remove(i.key,i);this.toIndex.clear(),this.toDestroy.clear()}getID(t){return this.registry.getID(t)}destroy(t){this.toDestroy.add(t)}create(t,e={},s=[]){const i=new t(this,e,s);return this.indexEntity(i),i}}class X{constructor(t){this.stack=[],this.ctx=t}visit(t){const e={};for(const s of Object.getOwnPropertyNames(t)){const i=this.serializeValue(t[s]);i!==void 0&&(e[s]=i)}return e}serializeValue(t){let e=t;switch(this.stack.push(t),typeof t){case"object":{if(Array.isArray(t))e=t.map(s=>typeof s=="object"?s&&this.visit(s):this.serializeValue(s));else if(t)if(t.toJSON)e=t.toJSON();else if(t instanceof D)e=[A,t.id].join("|");else for(const s of Object.getOwnPropertyNames(t)){const i=t[s];this.stack.includes(i)||(t[s]=i&&this.serializeValue(i))}break}case"bigint":e=`${t}n`;break;case"number":case"string":case"boolean":{e=t;break}}return this.stack.pop(),e}serializeEntities(t){this.stack=[];const e=t.entityFilter??(()=>!0),i=this.ctx.manager.index.all().filter(e).map(r=>{const o=!r.constructor.name||r.constructor.name===v?r.items.map(c=>c.type).join("|"):r.constructor.name;return{id:r.id,type:o,tags:Array.from(r.tags),$:this.visit(r.$)}});return this.stack=[],i}serialize(t={}){return{state:this.ctx.state,entities:this.serializeEntities(t)}}}class Z{constructor(t){this.ref=null,this.ref=t??null}}class D{constructor(t,e={},s=[]){this.referenced=new Set,this.key=0n,this.id=O(),this.components={all:this.allComponents.bind(this),has:this.hasComponents.bind(this),add:this.addComponent.bind(this),remove:this.removeComponents.bind(this)},this.manager=t,this.tags=new T(s,()=>this.manager.indexEntity(this)),this.$=this.getBindings(e),this.items=this.items.slice()}static with(...t){return B(this,...t)}has(...t){return t.every(e=>e.type in this.$)}is(...t){return this.tags.has(...t)}destroy(){for(const t of this.referenced)t.ref=null;this.manager.destroy(this)}getBindings(t){const e={};for(const s of this.items){const[i,r]=[s.type,new s];r instanceof Z?(Object.defineProperty(e,i,{get:()=>r.ref,set:o=>{r.ref=o,r.ref?.referenced.add(r)}}),r.ref=t[i]??null,r.ref?.referenced.add(r)):e[i]=Object.assign(r,t[i]??{})}return e}allComponents(){return Object.values(this.$)}hasComponents(...t){return t.every(e=>e.type in this.$)}addComponent(t,e){const s=t.type;this.$[s]||(this.$[s]=new t(e),this.items.push(t),this.manager.indexEntity(this))}removeComponents(...t){for(const e of t)e.type in this.$&&(this.items.splice(this.items.indexOf(e),1),delete this.$[e.type],this.manager.indexEntity(this))}}class Q{constructor(t){this.ctx=t}static ofType(){return this}}function tt(...n){const t=n.sort((e,s)=>(s.priority??0)-(e.priority??0));return class extends Q{constructor(){super(...arguments);this.pipeline=[]}async tick(s,i){for(const r of this.pipeline)await r.tick?.(s,i),this.ctx.manager.tick()}async stop(){for(const s of this.pipeline)await s.stop?.(),this.ctx.manager.tick()}async start(){this.pipeline=t.map(s=>H(s)?new s(this.ctx):{tick:(i,r)=>s(this.ctx,i,r)});for(const s of this.pipeline)await s.start?.(),this.ctx.manager.tick()}}}class et{constructor(t){this.locked=!1,this.registrations={components:{},entities:{}},this.manager=new U,this.state=t??null;const e=tt(...this.items);this.pipeline=new e(this)}static with(...t){return K(this,...t)}get items(){return[]}async tick(t,e){this.locked?console.warn("Tick duration exceeds tick rate."):(this.locked=!0,await this.pipeline.tick?.(t,e),this.manager.tick(),this.locked=!1)}load(t){new F(this).deserialize(t),this.manager.tick()}save(t){return new X(this).serialize(t)}register(t){const e=[];for(const s of Object.values(t))if(Y(s)){const i=s.name===v?s.prototype.items.map(r=>r.type).join("|"):s.name;this.registrations.entities[i]=s}else this.registrations.components[s.type]=s,e.push(s);this.manager.register(...e)}async start(){await this.pipeline.start?.(),this.manager.tick(),await this.tick(0,0)}async stop(){await this.pipeline.stop?.()}create(t,e={},s=[]){return this.manager.create(t,e,s)}get $(){return new j(this.manager)}}var st=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},P={exports:{}};(function(n,t){(function(e,s){n.exports=s()})(st,function(){var e=function(){function s(d){return o.appendChild(d.dom),d}function i(d){for(var u=0;u<o.children.length;u++)o.children[u].style.display=u===d?"block":"none";r=d}var r=0,o=document.createElement("div");o.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",o.addEventListener("click",function(d){d.preventDefault(),i(++r%o.children.length)},!1);var c=(performance||Date).now(),a=c,h=0,y=s(new e.Panel("FPS","#0ff","#002")),m=s(new e.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var p=s(new e.Panel("MB","#f08","#201"));return i(0),{REVISION:16,dom:o,addPanel:s,showPanel:i,begin:function(){c=(performance||Date).now()},end:function(){h++;var d=(performance||Date).now();if(m.update(d-c,200),d>a+1e3&&(y.update(1e3*h/(d-a),100),a=d,h=0,p)){var u=performance.memory;p.update(u.usedJSHeapSize/1048576,u.jsHeapSizeLimit/1048576)}return d},update:function(){c=this.end()},domElement:o,setMode:i}};return e.Panel=function(s,i,r){var o=Infinity,c=0,a=Math.round,h=a(window.devicePixelRatio||1),y=80*h,m=48*h,p=3*h,d=2*h,u=3*h,g=15*h,k=74*h,w=30*h,E=document.createElement("canvas");E.width=y,E.height=m,E.style.cssText="width:80px;height:48px";var f=E.getContext("2d");return f.font="bold "+9*h+"px Helvetica,Arial,sans-serif",f.textBaseline="top",f.fillStyle=r,f.fillRect(0,0,y,m),f.fillStyle=i,f.fillText(s,p,d),f.fillRect(u,g,k,w),f.fillStyle=r,f.globalAlpha=.9,f.fillRect(u,g,k,w),{dom:E,update:function(b,z){o=Math.min(o,b),c=Math.max(c,b),f.fillStyle=r,f.globalAlpha=1,f.fillRect(0,0,y,g),f.fillStyle=i,f.fillText(a(b)+" "+s+" ("+a(o)+"-"+a(c)+")",p,d),f.drawImage(E,u+h,g,k-h,w,u,g,k-h,w),f.fillRect(u+k-h,g,h,w),f.fillStyle=r,f.globalAlpha=.9,f.fillRect(u+k-h,g,h,a((1-b/z)*w))}}},e})})(P);var it=P.exports;export{$ as C,D as E,it as S,et as a};
